name: Docker

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  SLACK_NOTIFICATIONS_MESSAGE_CONFIG:
    SUCCESS:
      SLACK_COLOR: '#0c0'
      SLACK_USERNAME: Github Actions
      SLACK_TITLE: Job successed
      SLACK_MESSAGE: Куда это мы собрались? оО
      SLACK_CHANNEL: basics-code-auto
      SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
    FAIL:
      SLACK_COLOR: '#c00'
      SLACK_USERNAME: Github Actions
      SLACK_TITLE: Job failed
      SLACK_MESSAGE: Я упал, поднимите меня!
      SLACK_CHANNEL: basics-code-auto
      SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
  SLACK_NOTIFICATION: ${{ env.SLACK_NOTIFICATIONS_MESSAGE_CONFIG.SUCCESS }}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: |
          docker-compose --file docker-compose.test.yml buildss
          docker-compose --file docker-compose.test.yml run sut
      - name: The job has failed
        if: ${{ failure() }}
        env:
          SLACK_NOTIFICATION: ${{ env.SLACK_NOTIFICATIONS_MESSAGE_CONFIG.FAIL }}

  build-push:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Build and push
        uses: docker/build-push-action@v1.1.0
        with:
          repository: ${{ env.GITHUB_REPOSITORY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          tags: latest
      - name: The job has failed
        if: ${{ failure() }}
        env:
          SLACK_NOTIFICATION: ${{ env.SLACK_NOTIFICATIONS_MESSAGE_CONFIG.FAIL }}

  slack-notify:
    needs: [test, build-push]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Send message
        uses: rtCamp/action-slack-notify@v2.0.0
        env: ${{ env.SLACK_NOTIFICATION }}
